{
 "allow_comments": 0,
 "allow_delete": 0,
 "allow_edit": 0,
 "allow_incomplete": 0,
 "allow_multiple": 0,
 "allow_print": 0,
 "anonymous": 0,
 "apply_document_permissions": 0,
 "button_label": "Save",
 "client_script": "// \u2705 Updated Gym Subscription Web Form Client Script\n\nfrappe.web_form.after_load = () => {\n    console.log(\"\u2705 Gym Subscription Web Form loaded\");\n\n    // Initial calculations and UI setup\n    update_end_date();\n    update_final_price();\n    update_locker_description();\n    fetch_and_show_available_lockers();\n    calculate_remaining_days();\n\n    // Event listeners\n    frappe.web_form.on('start_date', () => {\n        update_end_date();\n        calculate_remaining_days();\n    });\n    frappe.web_form.on('end_date', calculate_remaining_days);\n    frappe.web_form.on('plan_type', () => {\n        update_end_date();\n        update_final_price();\n        calculate_remaining_days();\n    });\n    frappe.web_form.on('locker', () => {\n        update_final_price();\n        update_locker_description();\n    });\n};\n\nfunction update_end_date() {\n    let start_date = frappe.web_form.get_value('start_date');\n    let plan_type = frappe.web_form.get_value('plan_type');\n\n    if (!start_date || !plan_type) return;\n\n    let months = 0;\n\n    if (plan_type.includes(\"1 Month\")) {\n        months = 1;\n    } else if (plan_type.includes(\"3 Months\")) {\n        months = 3;\n    } else if (plan_type.includes(\"1 Year\")) {\n        months = 12;\n    }\n\n    if (months > 0) {\n        const end_date = frappe.datetime.add_months(start_date, months);\n        frappe.web_form.set_value('end_date', frappe.datetime.obj_to_str(end_date));\n        console.log(\"\ud83d\uddd5 End Date Updated:\", end_date);\n    }\n}\n\nfunction update_final_price() {\n    let plan_type = frappe.web_form.get_value('plan_type');\n    let locker = frappe.web_form.get_value('locker');\n\n    if (!plan_type) return;\n\n    let price_match = plan_type.match(/\u20b9(\\d+)/);\n    let base_price = price_match ? parseInt(price_match[1]) : 0;\n    let locker_count = parseInt(locker) || 0;\n\n    frappe.call({\n        method: \"frappe.client.get\",\n        args: {doctype: \"Gym Settings\", name: \"Gym Settings\"},\n        callback: function(r) {\n            let locker_price = 0;\n            if (r.message && r.message.locker_price_1m) {\n                locker_price = r.message.locker_price_1m * locker_count;\n            }\n            let total_price = base_price + locker_price;\n            frappe.web_form.set_value('final_price', total_price);\n            console.log(`\ud83d\udcb8 Final Price Updated: \u20b9${total_price}`);\n        }\n    });\n}\n\nfunction update_locker_description() {\n    let locker = frappe.web_form.get_value('locker');\n    let locker_count = parseInt(locker) || 0;\n\n    if (locker_count === 0) {\n        frappe.web_form.fields_dict.locker.df.description = \"\";\n    } else {\n        let locker_numbers = [];\n        for (let i = 0; i < locker_count; i++) {\n            let rand_num = Math.floor(100 + Math.random() * 900);\n            locker_numbers.push(`L${rand_num}`);\n        }\n        frappe.web_form.fields_dict.locker.df.description = \"Assigned Lockers: \" + locker_numbers.join(\", \");\n    }\n    frappe.web_form.fields_dict.locker.refresh();\n}\n\nfunction fetch_and_show_available_lockers() {\n    frappe.call({\n        method: \"frappe.client.get\",\n        args: {doctype: \"Gym Settings\", name: \"Gym Settings\"},\n        callback: function(r) {\n            if (r.message) {\n                let settings = r.message;\n                let available = settings.total_lockers - settings.used_lockers;\n                console.log(`Available lockers: ${available}`);\n                if (frappe.web_form.fields_dict.available_lockers) {\n                    frappe.web_form.set_value(\"available_lockers\", available);\n                }\n            }\n        }\n    });\n}\n\n// \u2728 Trainer Filter Based on Specialization\nfrappe.web_form.on('specialization', () => {\n    const specialization = frappe.web_form.get_value(\"specialization\");\n    console.log(\"\ud83d\udd04 Specialization Selected:\", specialization);\n\n    if (!specialization) {\n        console.warn(\"\u26a0\ufe0f No specialization selected\");\n        return;\n    }\n\n    frappe.call({\n        method: \"gym_management.jim.api.get_filtered_trainers\",\n        args: {\n            doctype: \"Gym Trainer\",\n            txt: \"\",\n            searchfield: \"full_name\",\n            start: 0,\n            page_len: 20,\n            filters: JSON.stringify({ specialization })\n        },\n        callback: function (r) {\n            console.log(\"\u2705 API Response:\", r.message);\n\n            const trainerSelect = document.querySelector('select[data-fieldname=\"trainer\"]');\n            if (!trainerSelect) {\n                console.warn(\"Trainer select field not found\");\n                return;\n            }\n\n            trainerSelect.innerHTML = \"\";\n\n            if (r.message && r.message.length > 0) {\n                r.message.forEach(opt => {\n                    const optionElem = document.createElement(\"option\");\n                    optionElem.value = opt.value || opt.name || opt.label || \"\";\n                    optionElem.textContent = opt.label || opt.value || opt.name || \"\";\n                    trainerSelect.appendChild(optionElem);\n                });\n            } else {\n                const optionElem = document.createElement(\"option\");\n                optionElem.value = \"\";\n                optionElem.textContent = \"No trainers available\";\n                trainerSelect.appendChild(optionElem);\n            }\n\n            trainerSelect.dispatchEvent(new Event('change'));\n            console.log(\"\u2705 Trainer options updated dynamically\");\n        },\n        error: function (err) {\n            console.error(\"\u274c API Error:\", err);\n        }\n    });\n});\n\n// \ud83d\udcc5 Dynamic Remaining Days in End Date Description\nfunction calculate_remaining_days() {\n    let start = frappe.web_form.get_value('start_date');\n    let end = frappe.web_form.get_value('end_date');\n\n    if (!start || !end) return;\n\n    const today = frappe.datetime.get_today();\n\n    if (frappe.datetime.obj_to_str(end) >= today) {\n        const startDate = frappe.datetime.str_to_obj(start);\n        const endDate = frappe.datetime.str_to_obj(end);\n        const diffMs = endDate - new Date();\n        const daysLeft = Math.floor(diffMs / (1000 * 60 * 60 * 24));\n\n        if (daysLeft >= 0 && frappe.web_form.fields_dict.end_date) {\n            frappe.web_form.fields_dict.end_date.df.description = `${daysLeft} day(s) remaining`;\n            frappe.web_form.fields_dict.end_date.refresh();\n        }\n    }\n}\n\n// \ud83d\udccf BMI Calculation for Metrics Update child table\nsetTimeout(() => {\n    const grid = frappe.web_form.fields_dict.metrics_update?.grid;\n    if (!grid) {\n        console.error(\"\u274c Child table grid not found\");\n        return;\n    }\n\n    grid.wrapper.on('blur', 'input[data-fieldname=\"current_height\"], input[data-fieldname=\"current_weight\"]', function () {\n        const $row = $(this).closest('.grid-row');\n        const row_name = $row.attr(\"data-name\");\n\n        if (!row_name) {\n            console.warn(\"\u26a0\ufe0f Could not get row name\");\n            return;\n        }\n\n        const rows = frappe.web_form.get_value(\"metrics_update\") || [];\n        const row = rows.find(r => r.name === row_name);\n\n        if (!row) {\n            console.warn(\"\u26a0\ufe0f Could not find row with name:\", row_name);\n            return;\n        }\n\n        let height = parseFloat(row.current_height);\n        let weight = parseFloat(row.current_weight);\n\n        if (!height || !weight || height === 0) {\n            console.log(\"\u26a0\ufe0f Missing or invalid inputs for BMI calculation\");\n            row.bmi = \"\";\n        } else {\n            let height_m = height / 100;\n            let bmi = weight / (height_m * height_m);\n            row.bmi = bmi.toFixed(2);\n            console.log(`\u2705 Calculated BMI for row ${row_name}: ${row.bmi}`);\n        }\n\n        frappe.web_form.set_value(\"metrics_update\", rows).then(() => {\n            console.log(\"\u2705 BMI updated in the form\");\n        });\n    });\n\n    console.log(\"\u2705 Listeners for current_height and current_weight attached\");\n}, 500);\n",
 "condition_json": "[]",
 "creation": "2025-07-01 16:49:34.571329",
 "doc_type": "Gym Membership",
 "docstatus": 0,
 "doctype": "Web Form",
 "idx": 0,
 "is_standard": 1,
 "list_columns": [],
 "login_required": 0,
 "max_attachment_size": 0,
 "modified": "2025-07-04 14:59:31.769996",
 "modified_by": "Administrator",
 "module": "Jim",
 "name": "gym-membership-form",
 "owner": "Administrator",
 "published": 1,
 "route": "gym-subscription",
 "show_attachments": 0,
 "show_list": 0,
 "show_sidebar": 0,
 "title": "Gym Subscription",
 "web_form_fields": [
  {
   "allow_read_on_all_link_options": 0,
   "fieldname": "member",
   "fieldtype": "Link",
   "hidden": 0,
   "label": "Member",
   "max_length": 0,
   "max_value": 0,
   "options": "User",
   "precision": "",
   "read_only": 0,
   "reqd": 0,
   "show_in_filter": 0
  },
  {
   "allow_read_on_all_link_options": 0,
   "fieldname": "plan_type",
   "fieldtype": "Select",
   "hidden": 0,
   "label": "Plan Type",
   "max_length": 0,
   "max_value": 0,
   "options": "1 Month >> (\u20b95000)\n3 Months  >> (\u20b99000)\n1 Year >> (\u20b914000)",
   "precision": "",
   "read_only": 0,
   "reqd": 0,
   "show_in_filter": 0
  },
  {
   "allow_read_on_all_link_options": 0,
   "fieldname": "start_date",
   "fieldtype": "Date",
   "hidden": 0,
   "label": "Start Date",
   "max_length": 0,
   "max_value": 0,
   "precision": "",
   "read_only": 0,
   "reqd": 0,
   "show_in_filter": 0
  },
  {
   "allow_read_on_all_link_options": 0,
   "fieldname": "end_date",
   "fieldtype": "Date",
   "hidden": 0,
   "label": "End Date",
   "max_length": 0,
   "max_value": 0,
   "precision": "",
   "read_only": 0,
   "reqd": 0,
   "show_in_filter": 0
  },
  {
   "allow_read_on_all_link_options": 0,
   "fieldname": "status",
   "fieldtype": "Select",
   "hidden": 0,
   "label": "Status",
   "max_length": 0,
   "max_value": 0,
   "options": "Active\nExpired\nCancelled",
   "precision": "",
   "read_only": 0,
   "reqd": 0,
   "show_in_filter": 0
  },
  {
   "allow_read_on_all_link_options": 0,
   "fieldname": "locker",
   "fieldtype": "Select",
   "hidden": 0,
   "label": "Locker",
   "max_length": 0,
   "max_value": 0,
   "options": "0\n1\n2",
   "precision": "",
   "read_only": 0,
   "reqd": 0,
   "show_in_filter": 0
  },
  {
   "allow_read_on_all_link_options": 0,
   "fieldname": "final_price",
   "fieldtype": "Float",
   "hidden": 0,
   "label": "Final Price",
   "max_length": 0,
   "max_value": 0,
   "precision": "",
   "read_only": 1,
   "reqd": 0,
   "show_in_filter": 0
  },
  {
   "allow_read_on_all_link_options": 0,
   "fieldname": "section_break_p5yw",
   "fieldtype": "Section Break",
   "hidden": 0,
   "max_length": 0,
   "max_value": 0,
   "precision": "",
   "read_only": 0,
   "reqd": 0,
   "show_in_filter": 0
  },
  {
   "allow_read_on_all_link_options": 0,
   "fieldname": "full_name",
   "fieldtype": "Data",
   "hidden": 0,
   "label": "Full Name",
   "max_length": 0,
   "max_value": 0,
   "precision": "",
   "read_only": 0,
   "reqd": 0,
   "show_in_filter": 0
  },
  {
   "allow_read_on_all_link_options": 0,
   "fieldname": "contact_number",
   "fieldtype": "Data",
   "hidden": 0,
   "label": "Contact Number",
   "max_length": 0,
   "max_value": 0,
   "precision": "",
   "read_only": 0,
   "reqd": 0,
   "show_in_filter": 0
  },
  {
   "allow_read_on_all_link_options": 0,
   "fieldname": "dob",
   "fieldtype": "Date",
   "hidden": 0,
   "label": "Date of Birth",
   "max_length": 0,
   "max_value": 0,
   "precision": "",
   "read_only": 0,
   "reqd": 0,
   "show_in_filter": 0
  },
  {
   "allow_read_on_all_link_options": 0,
   "fieldname": "gender",
   "fieldtype": "Select",
   "hidden": 0,
   "label": "Gender",
   "max_length": 0,
   "max_value": 0,
   "options": "Male\nFemale",
   "precision": "",
   "read_only": 0,
   "reqd": 0,
   "show_in_filter": 0
  },
  {
   "allow_read_on_all_link_options": 0,
   "fieldname": "address",
   "fieldtype": "Small Text",
   "hidden": 0,
   "label": "Address",
   "max_length": 0,
   "max_value": 0,
   "precision": "",
   "read_only": 0,
   "reqd": 0,
   "show_in_filter": 0
  },
  {
   "allow_read_on_all_link_options": 0,
   "fieldname": "locker_description",
   "fieldtype": "Data",
   "hidden": 0,
   "label": "Locker Description",
   "max_length": 0,
   "max_value": 0,
   "precision": "",
   "read_only": 1,
   "reqd": 0,
   "show_in_filter": 0
  },
  {
   "allow_read_on_all_link_options": 0,
   "fieldname": "specialization",
   "fieldtype": "Link",
   "hidden": 0,
   "label": "Specialization",
   "max_length": 0,
   "max_value": 0,
   "options": "Specializations",
   "precision": "",
   "read_only": 0,
   "reqd": 0,
   "show_in_filter": 0
  },
  {
   "allow_read_on_all_link_options": 0,
   "fieldname": "trainer",
   "fieldtype": "Select",
   "hidden": 0,
   "label": "Trainer",
   "max_length": 0,
   "max_value": 0,
   "precision": "",
   "read_only": 0,
   "reqd": 0,
   "show_in_filter": 0
  },
  {
   "allow_read_on_all_link_options": 0,
   "fieldname": "rating_for_trainer",
   "fieldtype": "Rating",
   "hidden": 0,
   "label": "Rating for Trainer",
   "max_length": 0,
   "max_value": 0,
   "precision": "",
   "read_only": 0,
   "reqd": 0,
   "show_in_filter": 0
  },
  {
   "allow_read_on_all_link_options": 0,
   "fieldname": "metrics_update",
   "fieldtype": "Table",
   "hidden": 0,
   "label": "Metrics Update",
   "max_length": 0,
   "max_value": 0,
   "options": "Metrics Update",
   "precision": "",
   "read_only": 0,
   "reqd": 0,
   "show_in_filter": 0
  }
 ]
}